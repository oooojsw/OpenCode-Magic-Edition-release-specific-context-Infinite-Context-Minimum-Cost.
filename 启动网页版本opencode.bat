@echo off
:: 设置UTF-8编码
chcp 65001 >nul
title OpenCode 网页版启动器 (极简可靠版)

echo ========================================================
echo        OpenCode 魔改版 - 网页版一键启动
echo ========================================================
echo.

:: 关键：临时将 Bun 的安装路径加到 PATH
set PATH=%PATH%;%USERPROFILE%\.bun\bin

:: ----------------------------------------------------------
:: 首次运行时，自动修复并安装依赖
:: ----------------------------------------------------------
if not exist "node_modules" (
    echo [!] 首次运行，正在为你准备环境...
    echo.
    del bun.lockb /q >nul 2>nul
    echo [+] 正在下载核心依赖包...
    call bun install
    echo [+] 正在安装兼容性补丁...
    call bun add entities
    echo.
    echo [V] 环境已准备就绪！
)

:: ----------------------------------------------------------
:: 检查并生成配置文件
:: ----------------------------------------------------------
if not exist ".env" (
    echo [!] 正在生成配置文件 .env...
    (echo # 请在这里填入你的 API Key & echo ANTHROPIC_API_KEY=) > .env
    echo.
    echo [!!!] 重要：请用记事本打开 .env 文件，填入你的 API Key！
    echo.
    echo    填好并保存后，回来按任意键继续...
    pause
)

:: ----------------------------------------------------------
:: 启动服务器并立即打开浏览器
:: ----------------------------------------------------------
echo.
echo [+] 正在启动服务器...
echo      如果浏览器显示“无法访问”，请等待几秒后手动刷新一下。
echo.

:: 立即在后台打开浏览器
start "" "http://localhost:4096"

:: 在当前窗口启动服务器
bun dev -- serve

pause